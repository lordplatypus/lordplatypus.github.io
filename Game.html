<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Game</title>
	</head>
	<body>
		<canvas id="main_canvas" width="480px" height="320px"></canvas>
		<div id="main_view"></div>
		<input id="file_input" type="file">
		<input id="column_input" type="number" value="4">Columns</input>
		<input id="row_input" type="number" value="4">Rows</input>
		<input id="num_display_input" type="checkbox" value="false">Display Numbers?</input>
		<input id="outline_display_input" type="checkbox" value="false">Display Outlines?</input>
        <button id="shuffle_button" type="button">Shuffle</button>
		<script src="./functions.js"></script>
		<script src="./object.js"></script>
		<script src="./manager.js"></script>
		<script type="text/javascript">

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Global Variables
			////////////////////////////////////////////////////////////////////////////////////////////////////
			var manager_ = new manager(); //Object Manager
			var image_; //image object
			var textureWidth_; //width of the texture, doesn't change
			var textureHeight_; //height of the texture, doesn't change
			var imageWidth_; //width of the image, after scaling
			var imageHeight_; //height of the image, after scaling
			var boxWidth_; //width of the individual image boxes (imageWidth_ / columns_)
			var boxHeight_; //height of the individual image boxes (imageHeight_ / rows_)
			var columns_ = 4;
			var rows_ = 4;
			var boxNum_ = 0;

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Init
			////////////////////////////////////////////////////////////////////////////////////////////////////
			window.onload = function ()
			{
				var el = $("main_canvas");
				el.addEventListener("touchstart", TouchStart, false);
				el.addEventListener("touchmove", TouchMove, false);
				el.addEventListener("touchend", TouchEnd, false);
				//el.addEventListener("touchcancel", handleCancel, false);

				Main();
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Inputs
			////////////////////////////////////////////////////////////////////////////////////////////////////
			input = document.querySelector("#file_input");
            input.addEventListener('change', function()
			{
				renderImage(this.files[0])
			});

			function renderImage(file) 
            {
                //generate a new FileReader object
                var reader = new FileReader();

                reader.onload = function(event) 
                {//get the data url and 
                    imagePath = event.target.result
					LoadImage(imagePath);
                }

                //when the file is read it triggers the onload event above.
                reader.readAsDataURL(file);
            }

			column_input = document.querySelector("#column_input");
            column_input.addEventListener("change", function()
            {
				columns_ = column_input.value;
            });

			row_input = document.querySelector("#row_input");
            row_input.addEventListener("change", function()
            {
				rows_ = row_input.value;
            });

			num_display_input = document.querySelector("#num_display_input");
            num_display_input.addEventListener("change", function()
            {
				manager_.DisplayNumbers(num_display_input.value);
            });

			outline_display_input = document.querySelector("#outline_display_input");
            outline_display_input.addEventListener("change", function()
            {
				manager_.DisplayOutlines(outline_display_input.value);
            });

			shuffle_button = document.querySelector("#shuffle_button");
            shuffle_button.addEventListener("click", function()
            {
				$('main_canvas').width = imageWidth_;
				$('main_canvas').height = imageHeight_;
				Clear();
				SetBoxes();
				Shuffle();
            });

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Game Functions
			////////////////////////////////////////////////////////////////////////////////////////////////////
			function LoadImage(imagePath)
			{
				image_ = new Image();
				image_.src = imagePath;
				image_.onload = function()
				{
					textureWidth_ = image_.naturalWidth;
					textureHeight_ = image_.naturalHeight;
					imageWidth_ = textureWidth_;
					imageHeight_ = textureHeight_; 

					if (window.innerWidth < textureWidth_ || window.innerHeight < textureHeight_) 
					{
						if (window.innerWidth <= window.innerHeight)
						{
							imageWidth_ = window.innerWidth;
							imageHeight_ = Math.floor(textureHeight_ / (textureWidth_ / imageWidth_));
						}
						else
						{
							imageHeight_ = window.innerHeight;
							imageWidth_ = Math.floor(textureWidth_ / (textureHeight_ / imageHeight_));
						}
					}

					console.log(imageWidth_);
					console.log(imageHeight_);
				}
			}

			function SetBoxSize()
			{
				boxWidth_ = Math.floor(imageWidth_ / columns_);
				boxHeight_ = Math.floor(imageHeight_ / rows_);
			}

			function Clear()
			{
				manager_.Clear();
				boxNum_ = 0;
			}

			function SetBoxes()
			{
				SetBoxSize();

				for (var y = 0; y < rows_; y++)
				{
					for (var x = 0; x < columns_; x++)
					{
						manager_.Add(new object(image_, boxWidth_*x, boxHeight_*y, boxWidth_, boxHeight_, 
						 	textureWidth_/columns_*x, textureHeight_/rows_*y, textureWidth_/columns_, textureHeight_/rows_, boxNum_, boxNum_));
						if (x === columns_ - 1 && y === rows_ - 1) break;
						boxNum_++;
					}
				}

				manager_.SearchByID(boxNum_).Display(false);
			}

			function Shuffle()
			{
				for (var i = 0; i < 100 * columns_ * rows_; i++)
				{
					var rand = Math.floor(Math.random() * 4);
					Swap(rand);
				}
			}

			function Swap(direction)
			{
				var emptyBox = manager_.SearchByID(boxNum_);
				var target;
				switch (direction)
				{
					case 0: //Down
					if (emptyBox.tag_ < columns_ * (rows_ - 1)) target = manager_.SearchByTag(emptyBox.tag_ + columns_);
					break;

					case 1: //Right
					if (emptyBox.tag_ % columns_ !== (columns_ - 1)) target = manager_.SearchByTag(emptyBox.tag_ + 1);
					break;

					case 2: //Up
					if (emptyBox.tag_ > columns_ - 1) target = manager_.SearchByTag(emptyBox.tag_ - columns_);
					break;

					case 3: //Left
					if (emptyBox.tag_ % columns_ !== 0) target = manager_.SearchByTag(emptyBox.tag_ - 1);
					break;
				}

				if (target === undefined) return;
				var tempTag = emptyBox.tag_;
				emptyBox.Translate(target.tag_ % columns_ * boxWidth_, Math.floor(target.tag_ / columns_) * boxHeight_, target.tag_);
				target.Translate(tempTag % columns_ * boxWidth_, Math.floor(tempTag / columns_) * boxHeight_, tempTag);
			}

			function CheckWinCondition()
			{
				for (var i = 0; i < boxNum_; i++)
				{
					var object = manager_.SearchByID(i);
					if (object.tag_ !== object.ID_) return false; 
				}
				return true;
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Game Update
			////////////////////////////////////////////////////////////////////////////////////////////////////
			function Main()
			{
				var ctx = $('main_canvas').getContext("2d");

				Update();
				Draw(ctx);

				var t = setTimeout(Main, 16);
			}

			function Update()
			{
				manager_.Update();
			}

			function Draw(ctx)
			{
				ctx.fillStyle = "#ff0000";
				ctx.fillRect(0, 0, imageWidth_, imageHeight_);

				manager_.Draw(ctx);
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Key and Touch Inputs
			////////////////////////////////////////////////////////////////////////////////////////////////////
			window.addEventListener("keydown", KeyDown, false);
			function KeyDown(inputEvent)
			{
				if (inputEvent.key == "w" || inputEvent.key == "i")
				{
					Swap(0);
				}
				else if (inputEvent.key == "a" || inputEvent.key == "j")
				{
					Swap(1);
				}
				else if (inputEvent.key == "s" || inputEvent.key == "k")
				{
					Swap(2);
				}
				else if (inputEvent.key == "d" || inputEvent.key == "l")
				{
					Swap(3);
				}

				if (CheckWinCondition()) manager_.SearchByID(boxNum_).Display(true);
			}

			var touchX_;
			var touchY_;
			function TouchStart(event) 
			{
				event.preventDefault();
				var touch = event.changedTouches[0];
				touchX_ = touch.pageX;
				touchY_ = touch.pageY;
			}

			function TouchMove(event) 
			{
				event.preventDefault();
			}

			function TouchEnd(event)
			{
				event.preventDefault();
				var touch = event.changedTouches[0];
				var touchEndX_ = touch.pageX;
				var touchEndY_ = touch.pageY;
				var distanceX = touchX_ - touchEndX_;
				var distanceY = touchY_ - touchEndY_;

				//var targetID = -1;
				if (Math.abs(distanceX) >= Math.abs(distanceY))
				{
					// if (distanceX >= 0) targetID = Search(boxes_[boxNum_].positionX_ + boxWidth_, boxes_[boxNum_].positionY_);//move left
					// else targetID = Search(boxes_[boxNum_].positionX_ - boxWidth_, boxes_[boxNum_].positionY_);//moved right
					if (distanceX >= 0) Swap(1);//move left
					else Swap(3);//moved right
				}
				else
				{
					// if (distanceY >= 0) targetID = Search(boxes_[boxNum_].positionX_, boxes_[boxNum_].positionY_ + boxHeight_);//move up
					// else targetID = Search(boxes_[boxNum_].positionX_, boxes_[boxNum_].positionY_ - boxHeight_);//moved down
					if (distanceY >= 0) Swap(2);//move up
					else Swap(0);//moved down
				}
				// if (targetID === -1) return;
				// var tempX = boxes_[boxNum_].positionX_;
				// var tempY = boxes_[boxNum_].positionY_;
				// boxes_[boxNum_].Translate(boxes_[targetID].positionX_, boxes_[targetID].positionY_);
				// boxes_[targetID].Translate(tempX, tempY);
			}

		</script>
    </body>
</html>