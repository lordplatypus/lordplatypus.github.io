<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Game</title>
	</head>
	<body>
		<canvas id="main_canvas" width="0px" height="0px"></canvas>
		<div id="main_view"></div>
		<div id="1">
			<input id="file_input" type="file">
		</div>
		<div id="2">
			<input id="column_input" type="number" value="4">Columns</input>
			<input id="row_input" type="number" value="4">Rows</input>
		</div>
		<div id="3">
			<input id="num_display_input" type="checkbox">Display Numbers?</input>
			<input id="num_size_input" type="number" value="15">Number Size</input>
			<input id="num_color_input" type="color" value="black">Number Color</input>
		</div>
		<div id="4">
			<input id="outline_display_input" type="checkbox">Display Outlines?</input>
			<input id="outline_size_input" type="number" value="2">Outline Size</input>
			<input id="outline_color_input" type="color" value="black">Outline Color</input>
		</div>
		<div id="5">
			<button id="shuffle_button" type="button">Shuffle</button>
		</div>
		<script src="./functions.js"></script>
		<script src="./object.js"></script>
		<script src="./manager.js"></script>
		<script type="text/javascript">

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Global Variables
			////////////////////////////////////////////////////////////////////////////////////////////////////
			var manager_ = new manager(); //Object Manager
			var image_; //image object
			var textureWidth_; //width of the texture, doesn't change
			var textureHeight_; //height of the texture, doesn't change
			var imageWidth_; //width of the image, after scaling
			var imageHeight_; //height of the image, after scaling
			var boxWidth_; //width of the individual image boxes (imageWidth_ / columns_)
			var boxHeight_; //height of the individual image boxes (imageHeight_ / rows_)
			var columns_ = 4;
			var rows_ = 4;
			var boxNum_ = 0;
			var touchX_;
			var touchY_;

			var mobile_ = false;

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Init
			////////////////////////////////////////////////////////////////////////////////////////////////////
			window.onload = function ()
			{
				//Add all the event listeners
				var fileInput = $("file_input");
				fileInput.addEventListener('change', ReadImage);

				var column_input = $("column_input");
            	column_input.addEventListener("change", ColumnInput);
				var row_input = $("row_input");
            	row_input.addEventListener("change", RowInput);

				var num_display_input = $("num_display_input");
            	num_display_input.addEventListener("change", DisplayNumbersInput);
				var num_size_input = $("num_size_input");
            	num_size_input.addEventListener("change", NumberSizeInput);
				var num_color_input = $("num_color_input");
            	num_color_input.addEventListener("change", NumberColorInput);

				var outline_display_input = $("outline_display_input");
            	outline_display_input.addEventListener("change", DisplayOutlinesInput);
				var outline_size_input = $("outline_size_input");
            	outline_size_input.addEventListener("change", OutlineSizeInput);
				var outline_color_input = $("outline_color_input");
            	outline_color_input.addEventListener("change", OutlineColorInput);

				var shuffle_button = $("shuffle_button");
            	shuffle_button.addEventListener("click", ShuffleButtonInput);

				var touch = $("main_canvas");
				touch.addEventListener("touchstart", TouchStart, false);
				touch.addEventListener("touchmove", TouchMove, false);
				touch.addEventListener("touchend", TouchEnd, false);
				//el.addEventListener("touchcancel", handleCancel, false);

				window.addEventListener("keydown", KeyDown, false);

				mobile_ = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
				console.log(mobile_);

				//Reset values - just a visual thing where values are still displayed but the actual value is empty
				fileInput.value = "";
				column_input.value = 4;
				row_input.value = 4;
				num_display_input.checked = false;
				outline_display_input.checked = false;

				//Start the main game loop
				Main();
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Inputs
			////////////////////////////////////////////////////////////////////////////////////////////////////	
			function ReadImage()
			{
				renderImage(this.files[0]);
			}

			function renderImage(file) 
            {
                //generate a new FileReader object
                var reader = new FileReader();

                reader.onload = function(event) 
                {//get the data url and 
                    imagePath = event.target.result
					LoadImage(imagePath);
                }

                //when the file is read it triggers the onload event above.
                reader.readAsDataURL(file);
            }

			function ColumnInput()
            {
				columns_ = parseInt(column_input.value, 10);
            }

			function RowInput()
            {
				rows_ = parseInt(row_input.value, 10);
            }

			function DisplayNumbersInput()
            {
				manager_.DisplayNumbers(num_display_input.checked);
            }

			function NumberSizeInput()
			{
				manager_.SetNumberSize(parseInt(num_size_input.value, 10));
			}

			function NumberColorInput()
			{
				manager_.SetNumberColor(num_color_input.value);
			}

			function DisplayOutlinesInput()
            {
				manager_.DisplayOutlines(outline_display_input.checked);
            }

			function OutlineSizeInput()
			{
				manager_.SetOutlineSize(parseInt(outline_size_input.value, 10));
			}

			function OutlineColorInput()
			{
				manager_.SetOutlineColor(outline_color_input.value);
			}

			function ShuffleButtonInput()
            {
				if ($("file_input").value === "") return;

				Clear(); //remove all objects
				SetBoxes(); //layout boxes determined by image width / height && columns / rows 
				Shuffle(); //suffle the boxes

				//DisplayNumbersInput(); //re-applies setting as all objects were deleted in "Clear()"
				//DisplayOutlinesInput(); //re-applies setting as all objects were deleted in "Clear()"

				$('main_canvas').width = boxWidth_ * columns_; //more tidy looking (background dosen't poke out) then using just imageWidth_ && imageHeight_
				$('main_canvas').height = boxHeight_ * rows_; //because a few pixles are lost when Math.floor is used to make the boxes "fit" nicer
            }

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Game Functions
			////////////////////////////////////////////////////////////////////////////////////////////////////
			function LoadImage(imagePath)
			{
				image_ = new Image();
				image_.src = imagePath;
				image_.onload = function()
				{
					textureWidth_ = image_.naturalWidth;
					textureHeight_ = image_.naturalHeight;
					imageWidth_ = textureWidth_;
					imageHeight_ = textureHeight_; 

					if (window.innerWidth < textureWidth_ || window.innerHeight < textureHeight_) 
					{
						if (window.innerWidth <= window.innerHeight)
						{
							imageWidth_ = window.innerWidth;
							imageHeight_ = Math.floor(textureHeight_ / (textureWidth_ / imageWidth_));
						}
						else
						{
							imageHeight_ = window.innerHeight;
							imageWidth_ = Math.floor(textureWidth_ / (textureHeight_ / imageHeight_));
						}
					}

					// console.log(imageWidth_);
					// console.log(imageHeight_);
				}
			}

			function SetBoxSize()
			{
				boxWidth_ = Math.floor(imageWidth_ / columns_);
				boxHeight_ = Math.floor(imageHeight_ / rows_);
			}

			function Clear()
			{
				manager_.Clear();
				boxNum_ = 0;
			}

			function SetBoxes()
			{
				SetBoxSize();

				for (var y = 0; y < rows_; y++)
				{
					for (var x = 0; x < columns_; x++)
					{
						manager_.Add(new object(image_, boxWidth_*x, boxHeight_*y, boxWidth_, boxHeight_, 
						 	textureWidth_/columns_*x, textureHeight_/rows_*y, textureWidth_/columns_, textureHeight_/rows_, boxNum_, boxNum_,
							num_display_input.checked, parseInt(num_size_input.value, 10), num_color_input.value,
							outline_display_input.checked, parseInt(outline_size_input.value, 10), outline_color_input.value));
						if (x === columns_ - 1 && y === rows_ - 1) break;
						boxNum_++;
					}
				}

				manager_.SearchByID(boxNum_).Display(false);
			}

			function Shuffle()
			{
				for (var i = 0; i < 100 * columns_ * rows_; i++)
				{
					var rand = Math.floor(Math.random() * 4);
					Swap(rand);
				}
			}

			function Swap(direction)
			{
				var emptyBox = manager_.SearchByID(boxNum_);
				var target;
				switch (direction)
				{
					case 0: //Down
					if (emptyBox.tag_ < columns_ * (rows_ - 1)) target = manager_.SearchByTag(emptyBox.tag_ + columns_);
					break;

					case 1: //Right
					if (emptyBox.tag_ % columns_ !== (columns_ - 1)) target = manager_.SearchByTag(emptyBox.tag_ + 1);
					break;

					case 2: //Up
					if (emptyBox.tag_ > columns_ - 1) target = manager_.SearchByTag(emptyBox.tag_ - columns_);
					break;

					case 3: //Left
					if (emptyBox.tag_ % columns_ !== 0) target = manager_.SearchByTag(emptyBox.tag_ - 1);
					break;
				}

				if (target === undefined) return;
				var tempTag = emptyBox.tag_;
				emptyBox.Translate(target.tag_ % columns_ * boxWidth_, Math.floor(target.tag_ / columns_) * boxHeight_, target.tag_);
				target.Translate(tempTag % columns_ * boxWidth_, Math.floor(tempTag / columns_) * boxHeight_, tempTag);
			}

			function CheckWinCondition()
			{
				for (var i = 0; i < boxNum_; i++)
				{
					var object = manager_.SearchByID(i);
					if (object.tag_ !== object.ID_) return false; 
				}
				return true;
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Game Update
			////////////////////////////////////////////////////////////////////////////////////////////////////
			function Main()
			{
				var ctx = $('main_canvas').getContext("2d");

				Update(delta_time());
				Draw(ctx);

				if (!mobile_) var t = setTimeout(Main, 0);
				else var t = setTimeout(Main, 16);
			}

			function Update(delta_time)
			{
				manager_.Update(delta_time);
			}

			function Draw(ctx)
			{
				ctx.fillStyle = "#ff0000";
				ctx.fillRect(0, 0, imageWidth_, imageHeight_);

				manager_.Draw(ctx);
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////
			///Key and Touch Inputs
			////////////////////////////////////////////////////////////////////////////////////////////////////
			function KeyDown(inputEvent)
			{
				if (inputEvent.key == "w" || inputEvent.key == "i")
				{
					Swap(0);
				}
				else if (inputEvent.key == "a" || inputEvent.key == "j")
				{
					Swap(1);
				}
				else if (inputEvent.key == "s" || inputEvent.key == "k")
				{
					Swap(2);
				}
				else if (inputEvent.key == "d" || inputEvent.key == "l")
				{
					Swap(3);
				}

				if (CheckWinCondition() && boxNum_ > 0) manager_.SearchByID(boxNum_).Display(true);
			}

			function TouchStart(event) 
			{
				event.preventDefault();
				var touch = event.changedTouches[0];
				touchX_ = touch.pageX;
				touchY_ = touch.pageY;
			}

			function TouchMove(event) 
			{
				event.preventDefault();
			}

			function TouchEnd(event)
			{
				event.preventDefault();
				var touch = event.changedTouches[0];
				var touchEndX_ = touch.pageX;
				var touchEndY_ = touch.pageY;
				var distanceX = touchX_ - touchEndX_;
				var distanceY = touchY_ - touchEndY_;

				if (Math.abs(distanceX) >= Math.abs(distanceY))
				{
					if (distanceX >= 0) Swap(1);//move left
					else Swap(3);//moved right
				}
				else
				{
					if (distanceY >= 0) Swap(0);//move up
					else Swap(2);//moved down
				}

				if (CheckWinCondition() && boxNum_ > 0) manager_.SearchByID(boxNum_).Display(true);
			}

		</script>
    </body>
</html>